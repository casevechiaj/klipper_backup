# This file contains common pin mappings for MKS Robin Nano V3
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "USB for communication".

# The "make flash" command does not work on the MKS Robin. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "Robin_nano_v3.bin" on an SD card and then restart the
# MKS Robin with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[include tmc.cfg]
[include EBB42 USB.cfg]
[include mainsail.cfg]
[include input shaper.cfg]
#[include adxl.cfg]
[exclude_object]
[include gcode arcs.cfg]
#[include START_PRINT.cfg]
#[include END_PRINT.cfg]
#[include SHAKETUNE.cfg]
[include macros.cfg]
[include Speed Test.cfg]

[stepper_x]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: PA15
position_min: 0
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: PE0
dir_pin: !PB9
enable_pin: !PE1
microsteps: 16
rotation_distance: 40
endstop_pin: PD2
position_min: 0
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 200

[stepper_z1] #E0 driver
step_pin: PD6
dir_pin: PD3
enable_pin: !PB3
microsteps: 16
rotation_distance: 8

[extruder]
max_extrude_only_distance: 1000.0
step_pin: toolhead: PD0
dir_pin: !toolhead: PD1
enable_pin: !toolhead: PD2
heater_pin: toolhead: PB13
sensor_pin: toolhead: PA3
rotation_distance: 23.202075542184
microsteps: 16
nozzle_diameter: 0.600
filament_diameter: 1.750
pressure_advance: 0
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300
sensor_type: EPCOS 100K B57560G104F
min_extrude_temp: 0
max_extrude_cross_section: 50

# sensor_pin: EBBCan: PA4
# spi_bus: spi1
# rtd_nominal_r: 100
# rtd_reference_r: 430
# rtd_num_of_wires: 2

[heater_bed]
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
#control: pid
#pid_Kp: 63.970
#pid_Ki: 1.143
#pid_Kd: 894.783
min_temp: 0
max_temp: 130

[temperature_sensor pi_temp]
sensor_type: temperature_host
min_temp: 10
max_temp:100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 10
max_temp:300

[controller_fan my_controller_fan]
pin: PB1    # fan 2
pin: PC14  # fan 1
max_power: 1
shutdown_speed: 0
cycle_time: .1
hardware_pwm: false
kick_start_time: .1
off_below: 0
#   See the "fan" section for a description of the above parameters.
fan_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver is active.
#   The default is 1.0
#idle_timeout:
#   The amount of time (in seconds) after a stepper driver or heater
#   was active and the fan should be kept running. The default
#   is 30 seconds.
#idle_speed: 1
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver was active and
#   before the idle_timeout is reached. The default is fan_speed.
stepper: stepper_x, stepper_y, stepper_z, stepper_z1
#   Name of the config section defining the heater/stepper that this fan
#   is associated with. If a comma separated list of heater/stepper names
#   is provided here, then the fan will be enabled when any of the given
#   heaters/steppers are enabled. The default heater is "extruder", the
#   default stepper is all of them.

[mcu]
serial: /dev/ttyAMA0
restart_method: command
#serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_470036001951343035323830-if00

[printer]
kinematics: cartesian
max_velocity: 450
max_accel: 20000
max_z_velocity: 25
max_z_accel: 100

[bed_mesh]
speed: 150
horizontal_move_z: 5
mesh_min: 39, 20           # front-left corner (nozzle), probe will reach X=0,Y=0
mesh_max: 196, 201 
probe_count: 5, 5
mesh_pps: 2, 3
algorithm: bicubic
bicubic_tension: 0.2
adaptive_margin: 1

[bltouch]
sensor_pin: ^toolhead: PB8
control_pin: toolhead: PB9
probe_with_touch_mode: true
x_offset: 39
y_offset: 4
#z_offset: 2.149
speed: 5.0
samples: 2
sample_retract_dist: 5.0
lift_speed: 40

[safe_z_home]
home_xy_position: 78, 113 # Change coordinates to the center of your print bed
speed: 150
z_hop: 10                   # Move up 5mm
z_hop_speed: 20

#[filament_switch_sensor filament_sensor]
#pause_on_runout: true
#switch_pin: toolhead: PB3

[auto_speed]
#axis: diag_x, diag_y  ; One or multiple of `x`, `y`, `diag_x`, `diag_y`, `z`

#margin: 20            ; How far away from your axes to perform movements

#settling_home: 1      ; Perform settling home before starting Auto Speed
#max_missed: 1.0       ; Maximum full steps that can be missed
#endstop_samples: 3    ; How many endstop samples to take for endstop variance

#accel_min: 1000.0     ; Minimum acceleration test may try
#accel_max: 50000.0    ; Maximum acceleration test may try
#accel_accu: 0.05      ; Keep binary searching until the result is within this percentage

#velocity_min: 50.0    ; Minimum velocity test may try
#velocity_max: 5000.0  ; Maximum velocity test may try
#velocity_accu: 0.05   ; Keep binary searching until the result is within this percentage

#derate: 0.8           ; Derate discovered results by this amount

#validate_margin: Unset      ; Margin for VALIDATE, Defaults to margin
#validate_inner_margin: 20.0 ; Margin for VALIDATE inner pattern
#validate_iterations: 50     ; Perform VALIDATE pattern this many times

#results_dir: ~/printer_data/config ; Destination directory for graphs

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5,  EXP1_3=PD13, EXP1_5=PE14, EXP1_7=PD11, EXP1_9=<GND>,
    EXP1_2=PE13, EXP1_4=PC6,  EXP1_6=PE15, EXP1_8=PD10, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE8, EXP2_5=PE11, EXP2_7=PE12,  EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PE10, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<3.3v>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"

# See the sample-lcd.cfg file for definitions of common LCD displays.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.015000, 0.035000, -0.020000
#*# compensation_start_x = 40.0
#*# compensation_end_x = 195.0
#*# zy_compensations = -0.012917, 0.017083, -0.004167
#*# compensation_start_y = 25.0
#*# compensation_end_y = 230.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.070
#*# pid_ki = 1.126
#*# pid_kd = 72.508
#*#
#*# [bed_mesh No Bowden]
#*# version = 1
#*# points =
#*# 	0.067541, 0.006614, 0.005686, -0.008080, -0.008435
#*# 	0.057035, 0.046108, -0.026070, 0.025164, 0.031059
#*# 	0.109029, 0.055602, 0.019674, 0.043408, 0.026803
#*# 	0.073898, 0.051720, 0.028293, 0.038277, 0.030422
#*# 	0.042017, 0.021089, 0.001412, 0.016396, -0.001459
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 39.0
#*# max_x = 196.0
#*# min_y = 20.0
#*# max_y = 201.0
#*#
#*# [bltouch]
#*# z_offset = 2.131
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.056142, 0.016465, 0.121788, 0.014271, 0.015167
#*# 	0.081886, 0.008459, -0.021219, 0.037515, 0.050910
#*# 	0.035130, 0.012953, 0.018275, 0.047009, 0.035404
#*# 	0.053749, 0.029072, 0.014394, 0.034378, 0.039023
#*# 	-0.000632, -0.014059, -0.018737, 0.014997, 0.008392
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 39.0
#*# max_x = 196.0
#*# min_y = 20.0
#*# max_y = 201.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.556
#*# pid_ki = 1.115
#*# pid_kd = 993.342
